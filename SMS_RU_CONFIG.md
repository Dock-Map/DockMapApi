# Настройка SMS.RU для DockMapApi

## Переменные окружения

Добавьте следующие переменные в ваш `.env` файл:

```env
# SMS.RU Configuration
SMS_RU_API_ID=your_api_id_here
SMS_RU_FROM=your_sender_name_here

# Тестовый режим (опционально)
SMS_TEST_MODE=true
```

## Получение API ID

1. Зарегистрируйтесь на [SMS.RU](https://sms.ru/?panel=api)
2. Перейдите в раздел "API"
3. Скопируйте ваш API ID

## Настройка отправителя

1. В личном кабинете SMS.RU создайте отправителя
2. Укажите имя отправителя в переменной `SMS_RU_FROM`

## Тестовый режим

Для разработки можно включить тестовый режим:

- Установите `SMS_TEST_MODE=true` в `.env`
- В тестовом режиме SMS не отправляются, но коды сохраняются в базе
- Код выводится в консоль и возвращается в ответе API

## Функциональность

- Отправка SMS с кодами верификации
- Локальное хранение кодов в базе данных
- Автоматическая очистка истекших кодов
- Проверка баланса
- Получение статуса отправки
- Обработка всех ошибок SMS.RU API

## API методы

- `POST /auth/sms/send` - Отправка SMS с кодом
- `POST /auth/sms/verify` - Проверка кода
- `GET /auth/sms/verification-code/:phone` - Получение кода (для тестирования)
- `POST /auth/sms/cleanup` - Очистка истекших кодов
- `GET /auth/sms/balance` - Проверка баланса

## Обработка ошибок

Система обрабатывает все основные ошибки SMS.RU:

- **201** - Недостаточно средств на балансе
- **202** - Неправильный логин или пароль
- **203** - Недостаточно средств на лицевом счете
- **204** - IP-адрес временно заблокирован
- **205** - Неверный формат номера телефона
- **206** - Сообщение запрещено
- **207** - Неверный формат имени отправителя
- **208** - Сообщение не может быть доставлено
- **209** - Слишком много запросов (лимит: 1 в минуту)
- **220** - Сервис временно недоступен
- **230** - Превышен лимит сообщений (100 в день на номер)
- **300** - Неправильный token
- **301** - Неправильный api_id
- **302** - IP не в списке разрешенных

## Миграция базы данных

Убедитесь, что таблица `verification_code` создана в базе данных:

```sql
CREATE TABLE verification_code (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  phone_number VARCHAR NOT NULL,
  code VARCHAR NOT NULL,
  is_used BOOLEAN DEFAULT FALSE,
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_verification_code_phone ON verification_code(phone_number);
CREATE INDEX idx_verification_code_expires ON verification_code(expires_at);
```

## Пополнение баланса

Для отправки SMS необходимо пополнить баланс в личном кабинете SMS.RU:

1. Перейдите в раздел "Пополнение"
2. Выберите способ оплаты
3. Пополните баланс на нужную сумму
