# Система верификации SMS

## Обзор

Система верификации SMS позволяет безопасно отправлять и проверять коды подтверждения для авторизации пользователей.

## Архитектура

### Сущности

1. **User** - основная сущность пользователя
2. **VerificationCode** - сущность для хранения кодов верификации

### Основные компоненты

- `UserService` - управление пользователями и кодами верификации
- `SmsService` - отправка SMS через Twilio
- `AuthService` - авторизация через SMS

## API Endpoints

### Отправка SMS кода
```
POST /auth/sms/send
Body: { "phoneNumber": "+79001234567" }
```

### Верификация SMS кода
```
POST /auth/sms/verify
Body: { "phoneNumber": "+79001234567", "code": "123456" }
```

### Очистка истекших кодов (админ)
```
DELETE /user/cleanup-expired-codes
```

## Безопасность

### Особенности реализации

1. **Время жизни кода**: 5 минут
2. **Одноразовое использование**: код помечается как использованный после проверки
3. **Автоматическая очистка**: истекшие коды удаляются
4. **Уникальность**: для каждого номера хранится только один активный код

### База данных

Таблица `verification_code` содержит:
- `id` - уникальный идентификатор
- `phoneNumber` - номер телефона (индексирован)
- `code` - код верификации
- `isUsed` - флаг использования
- `expiresAt` - время истечения
- `createdAt` - время создания

## Конфигурация

### Переменные окружения

```env
# Twilio
TWILIO_ACCOUNT_SID=your_account_sid
TWILIO_AUTH_TOKEN=your_auth_token
TWILIO_PHONE_NUMBER=your_twilio_number

# База данных
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_USER=dock
DATABASE_PASSWORD=dock
DATABASE_NAME=dock
```

## Логика работы

1. **Отправка кода**:
   - Генерируется 6-значный код
   - Удаляются старые коды для номера
   - Сохраняется новый код с TTL 5 минут
   - Отправляется SMS через Twilio

2. **Верификация кода**:
   - Проверяется существование кода
   - Проверяется срок действия
   - Проверяется соответствие кода
   - Код помечается как использованный
   - Создается/обновляется пользователь

3. **Очистка**:
   - Удаляются истекшие коды
   - Можно запускать по расписанию

## Тестирование

### Локальное тестирование

1. Запустите базу данных:
```bash
npm run setupBd
```

2. Запустите приложение:
```bash
npm run start:dev
```

3. Отправьте SMS:
```bash
curl -X POST http://localhost:3000/auth/sms/send \
  -H "Content-Type: application/json" \
  -d '{"phoneNumber": "+79001234567"}'
```

4. Проверьте код:
```bash
curl -X POST http://localhost:3000/auth/sms/verify \
  -H "Content-Type: application/json" \
  -d '{"phoneNumber": "+79001234567", "code": "123456"}'
```

## Мониторинг

### Логи

Система логирует:
- Отправку SMS кодов
- Ошибки отправки
- Попытки верификации
- Очистку истекших кодов

### Метрики

Рекомендуется отслеживать:
- Количество отправленных SMS
- Успешность верификации
- Время ответа API
- Ошибки Twilio

## Расширения

### Возможные улучшения

1. **Rate Limiting**: ограничение количества запросов
2. **Redis**: кэширование кодов для лучшей производительности
3. **Альтернативные провайдеры**: поддержка других SMS сервисов
4. **Аудио коды**: голосовые коды для доступности
5. **Блокировка**: временная блокировка при множественных ошибках 